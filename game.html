<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <title>game 1</title>
        <style media="screen">
            canvas {
                border: 1px black solid;
            }
        </style>
        <script src="utility.js"></script>
        <script src="Min_game.js"></script>
        <script src="Ball.js"></script>
        <script src="Paddle.js"></script>
        <script src="Block.js"></script>
        <script src="level.js"></script>
    </head>
    <body>
        <canvas id="id-canvas" width="400" height="300"></canvas>
    <script type="text/javascript">
        var loadLevel = function (n) {
            log("loadLevel start")
            var blocks = []
            var nowLevel = level[n-1]
            log("nowLevel", nowLevel)
            for (var i = 0; i < nowLevel.length ; i++) {
                var b = Block(nowLevel[i])
                blocks.push(b)
            }
            log("loadLevel end", blocks)
            return blocks
        }

        // プログラムの入り口は常に一つ
        // プログラムの基本単位はファンクション
        var __main = function() {
            log("main start")
            // オブジェクトのインスタンスを作る
            var game =  Min_game(30)
            var paddle = Paddle()
            var ball =  Ball()
            var blocks = loadLevel(2)
            // for (var i = 0; i < 3 ; i++) {
            //     var b = Block()
            //     b.y = 100
            //     b.x = 100 * i + 1
            //     blocks.push(b)
            // }


            paused = false

            //function化
             game.registerAction('d', function(){
                 paddle.moveRight()
             })

             game.registerAction('a', function(){
                 paddle.moveLeft()
             })

            game.registerAction('f', function(){
                 ball.fire()
             })

            // game.registerAction('p', function(){
            //      paused = !paused
            //  })
            window.addEventListener('keyup', function () {
                var k = event.key
                if(k == 'p') {
                    paused = !paused
                }else if ('1234567'.includes(k)) {
                    blocks = loadLevel(Number(k))
                // } else if (event.key == '2') {
                //     blocks = loadLevel(2)
                // } else if (event.key == '3') {
                //     blocks = loadLevel(3)
                 }
            })

             game.update = function() {
                if(paused) {
                   return
                }
                 ball.move()

                 //if collide
                 if(paddle.collide(ball)){
                     //ballの何かのメソッドを呼ぶべき
                     // ball.speedY *= -1
                     ball.rebound()
                 }
                 for (var i=0; i < blocks.length; i++) {
                     var block = blocks[i]
                     if(block.collide(ball)){
                         //ballの何かのメソッドを呼ぶべき
                         block.kill()
                         ball.rebound()
                     }
                 }

             }

             //定義するのがおかしい、理想形:game.draw(padle)
            //paddleを渡すために（setInterval)、ここで書かざるを得ない
             game.draw = function() {
                 //理想形:game.draw(paddle)
                 game.drawImage(paddle)
                 game.drawImage(ball)

                 for (var i=0; i < blocks.length; i++) {
                     var block = blocks[i]
                     if(block.alive) {
                         game.drawImage(block)
                     }
                 }
             }
        }

        __main()
    </script>

    </body>
</html>
